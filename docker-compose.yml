# ==========================================
# Pipe - Docker Compose (Producción)
# ==========================================
#
# Todas las variables se cargan desde ./.env
# Uso: docker compose up -d
#

services:
  # ==============================
  # PostgreSQL Database
  # ==============================
  pipe-postgres:
    image: postgres:15-alpine
    container_name: pipe-postgres
    restart: unless-stopped
    env_file:
      - ./.env
    environment:
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - pipe_postgres_data:/var/lib/postgresql/data
    ports:
      - "5440:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -h localhost -U $${POSTGRES_USER} -d $${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - pipe-network

  # ==============================
  # Qdrant Vector Database
  # ==============================
  pipe-qdrant:
    image: qdrant/qdrant:latest
    container_name: pipe-qdrant
    restart: unless-stopped
    ports:
      - "6444:6333"
    volumes:
      - pipe_qdrant_storage:/qdrant/storage
    healthcheck:
      test: ["CMD-SHELL", "bash -c ':> /dev/tcp/localhost/6333' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 25s
    networks:
      - pipe-network

  # ==============================
  # Redis Cache
  # ==============================
  pipe-redis:
    image: redis:7-alpine
    container_name: pipe-redis
    restart: unless-stopped
    env_file:
      - ./.env
    command: sh -c "redis-server --appendonly yes --requirepass $$REDIS_PASSWORD"
    ports:
      - "6379:6379"
    volumes:
      - pipe_redis_data:/data
    healthcheck:
      test: ["CMD-SHELL", "redis-cli -a $${REDIS_PASSWORD} ping | grep -q PONG"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - pipe-network

  # ==============================
  # Backend API
  # ==============================
  pipe-backend:
    build:
      context: .
      dockerfile: backend/Dockerfile
    container_name: pipe-backend
    restart: unless-stopped
    env_file:
      - ./.env
    volumes:
      - pipe_uploads:/app/databases/uploads
      - pipe_analyses:/app/data/analyses
    ports:
      - "8000:8000"
    depends_on:
      pipe-postgres:
        condition: service_healthy
      pipe-qdrant:
        condition: service_healthy
      pipe-redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -fs http://localhost:8000/ || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s
    networks:
      - pipe-network

# ==============================
# Volúmenes
# ==============================
volumes:
  pipe_postgres_data:
  pipe_qdrant_storage:
  pipe_redis_data:
  pipe_uploads:
  pipe_analyses:

# ==============================
# Red
# ==============================
networks:
  pipe-network:
    driver: bridge