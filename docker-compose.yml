# ==========================================
# Pipe - Docker Compose (Producción)
# ==========================================
#
# Todas las variables se cargan desde ./.env
# Uso: docker compose up -d
#

services:
  # ==============================
  # PostgreSQL Database
  # ==============================
  pipe-postgres:
    image: postgres:15-alpine
    container_name: pipe-postgres
    restart: unless-stopped
    env_file:
      - ./.env
    environment:
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - pipe_postgres_data:/var/lib/postgresql/data
    ports:
      - "5440:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -h localhost -U $${POSTGRES_USER} -d $${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - pipe-network

  # ==============================
  # Qdrant Vector Database
  # ==============================
  pipe-qdrant:
    image: qdrant/qdrant:latest
    container_name: pipe-qdrant
    restart: unless-stopped
    ports:
      - "6444:6333"
    volumes:
      - pipe_qdrant_storage:/qdrant/storage
    healthcheck:
      test: ["CMD-SHELL", "bash -c ':> /dev/tcp/localhost/6333' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 25s
    networks:
      - pipe-network

  # ==============================
  # Redis Cache
  # ==============================
  pipe-redis:
    image: redis:7-alpine
    container_name: pipe-redis
    restart: unless-stopped
    env_file:
      - ./.env
    command: sh -c "redis-server --appendonly yes --requirepass $$REDIS_PASSWORD"
    ports:
      - "6379:6379"
    volumes:
      - pipe_redis_data:/data
    healthcheck:
      test: ["CMD-SHELL", "redis-cli -a $${REDIS_PASSWORD} ping | grep -q PONG"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - pipe-network

  # ==============================
  # Langfuse Observability
  # ==============================
  pipe-langfuse:
    image: ghcr.io/langfuse/langfuse:2
    container_name: pipe-langfuse
    restart: unless-stopped
    env_file:
      - ./.env
    environment:
      # Use PostgreSQL (we already have it)
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@pipe-postgres:5432/langfuse
      
      # Auth
      NEXTAUTH_SECRET: ${LANGFUSE_NEXTAUTH_SECRET:-pipe-langfuse-secret-change-in-production}
      NEXTAUTH_URL: http://${SERVER_HOST:-192.168.10.20}:3000
      
      # Encryption salt (required for v2)
      SALT: ${LANGFUSE_SALT:-langfuse-self-hosted-salt-key-32chars-minimum-required-for-encryption-security}
      
      # Default credentials (use LANGFUSE_INIT_ prefix for v2+)
      LANGFUSE_INIT_USER_EMAIL: ${LANGFUSE_ADMIN_EMAIL:-admin@pipe.local}
      LANGFUSE_INIT_USER_NAME: "Admin"
      LANGFUSE_INIT_USER_PASSWORD: ${LANGFUSE_ADMIN_PASSWORD:-admin-change-me}
      
      # Initial Project (Optional but recommended)
      LANGFUSE_INIT_PROJECT_PUBLIC_KEY: ${LANGFUSE_PUBLIC_KEY:-pk-lf-self-hosted}
      LANGFUSE_INIT_PROJECT_SECRET_KEY: ${LANGFUSE_SECRET_KEY:-sk-lf-self-hosted}
      LANGFUSE_INIT_PROJECT_NAME: "Pipe Project"
    ports:
      - "3000:3000"
    depends_on:
      pipe-postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -fs http://localhost:3000/api/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s
    networks:
      - pipe-network

  # ==============================
  # Backend API
  # ==============================
  pipe-backend:
    build:
      context: .
      dockerfile: backend/Dockerfile
    image: pipe-pipe-backend:latest    # Reutiliza imagen existente si no se pasa --build
    container_name: pipe-backend
    restart: unless-stopped
    env_file:
      - ./.env
    command: ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000", "--reload", "--reload-dir", "/app/src"]
    volumes:
      - ./backend/src:/app/src
      - ./backend/main.py:/app/main.py
      - ./backend/langgraph.json:/app/langgraph.json
      - ./backend/index_docs.py:/app/index_docs.py
      # Volúmenes persistentes para datos
      - pipe_uploads:/app/databases/uploads
      - pipe_analyses:/app/data/analyses
    expose:
      - "8000"
    depends_on:
      pipe-postgres:
        condition: service_healthy
      pipe-qdrant:
        condition: service_healthy
      pipe-redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -fs http://localhost:8000/ || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s
    networks:
      - pipe-network

  # ==============================
  # Frontend Dev Server (Vite)
  # ==============================
  pipe-frontend:
    image: node:20-alpine
    container_name: pipe-frontend
    restart: unless-stopped
    working_dir: /app
    command: sh -c "npm install && npx vite --host"
    volumes:
      - ./frontend:/app
    ports:
      - "5173:5173"
    depends_on:
      - pipe-backend
    networks:
      - pipe-network

# ==============================
# Volúmenes
# ==============================
volumes:
  pipe_postgres_data:
  pipe_qdrant_storage:
  pipe_redis_data:
  pipe_uploads:
  pipe_analyses:

# ==============================
# Red
# ==============================
networks:
  pipe-network:
    driver: bridge